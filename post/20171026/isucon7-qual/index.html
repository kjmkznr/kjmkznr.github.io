<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://kjmkznr.github.io/stylesheets/shiori.css">
    <link href='//fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="https://kjmkznr.github.io/favicon.ico">
    <title>ISUCON7 予選参戦メモ | ただのメモ</title>
    
    


  </head>
  <body>
    <div class="navbar navbar-inverse navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <div class="navbar-toggle-wrapper visible-xs">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".js-navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <a href="https://kjmkznr.github.io" class="navbar-brand">ただのメモ</a>
        </div>
        <div class="collapse navbar-collapse js-navbar-collapse">
          <ul class="navbar-nav nav">
            <li><a href="https://kjmkznr.github.io/post">Archive</a></li>

          </ul>
        </div>
      </div>
    </div>
    <div class="container">

<div class="row">
  <div class="col-sm-8">
    <div class="post-header">
      <h1 class="post-title-main">ISUCON7 予選参戦メモ</h1>
      <p class="text-muted">Oct 26, 2017</p>

    </div>
    <div class="post-content">
      <p>2017/10/21〜22 に開催された ISUCON7 の予選に参加して、予選突破できたので、そのときのメモです。
22日（日曜）の方に参加しました。</p>
<h2 id="チーム構成">チーム構成</h2>
<h3 id="チーム名">チーム名</h3>
<p>oops</p>
<h3 id="メンバー">メンバー</h3>
<ul>
<li>2matz(インフラ、アプリ）</li>
<li>nyaa（アプリ、インフラ）</li>
<li>kjm（インフラ、アプリ）</li>
</ul>
<p>今は全員<a href="http://www.4cast.co.jp/recruit/recruit/carrier.html">同僚</a>。</p>
<h3 id="選択言語">選択言語</h3>
<p>Go言語</p>
<h2 id="点数の推移">点数の推移</h2>
<p><img src="https://kjmkznr.github.io/images/20171026/isucon7-qual-1.png" alt="oops のみのグラフ"></p>
<p>16時くらいまでは暫定一位だった。</p>
<p><img src="https://kjmkznr.github.io/images/20171026/isucon7-qual-2.png" alt="予選通過チームを含むグラフ"></p>
<table>
<thead>
<tr>
<th>時間</th>
<th>Score</th>
</tr>
</thead>
<tbody>
<tr>
<td>13:05:29</td>
<td>3,468</td>
</tr>
<tr>
<td>13:15:12</td>
<td>6,036</td>
</tr>
<tr>
<td>13:47:44</td>
<td>17,721</td>
</tr>
<tr>
<td>13:53:41</td>
<td>19,535</td>
</tr>
<tr>
<td>14:00:59</td>
<td>1,733</td>
</tr>
<tr>
<td>14:02:11</td>
<td>27,345</td>
</tr>
<tr>
<td>14:18:39</td>
<td>19,320</td>
</tr>
<tr>
<td>14:29:11</td>
<td>26,212</td>
</tr>
<tr>
<td>14:30:58</td>
<td>82,260</td>
</tr>
<tr>
<td>14:32:33</td>
<td>85,310</td>
</tr>
<tr>
<td>14:49:54</td>
<td>36,704</td>
</tr>
<tr>
<td>14:52:45</td>
<td>27,995</td>
</tr>
<tr>
<td>15:18:13</td>
<td>100,117</td>
</tr>
<tr>
<td>15:22:43</td>
<td>69,093</td>
</tr>
<tr>
<td>15:29:11</td>
<td>31,157</td>
</tr>
<tr>
<td>15:38:11</td>
<td>65,097</td>
</tr>
<tr>
<td>15:39:40</td>
<td>68,131</td>
</tr>
<tr>
<td>15:42:03</td>
<td>106,396</td>
</tr>
<tr>
<td>15:48:01</td>
<td>98,140</td>
</tr>
<tr>
<td>16:03:03</td>
<td>85,097</td>
</tr>
<tr>
<td>16:08:42</td>
<td>142,119</td>
</tr>
<tr>
<td>16:18:00</td>
<td>30,340</td>
</tr>
<tr>
<td>16:22:39</td>
<td>57,593</td>
</tr>
<tr>
<td>16:26:21</td>
<td>44,667</td>
</tr>
<tr>
<td>16:30:43</td>
<td>38,876</td>
</tr>
<tr>
<td>16:32:31</td>
<td>67,046</td>
</tr>
<tr>
<td>16:37:13</td>
<td>37,649</td>
</tr>
<tr>
<td>16:42:17</td>
<td>46,491</td>
</tr>
<tr>
<td>16:45:52</td>
<td>32,706</td>
</tr>
<tr>
<td>17:01:03</td>
<td>91,630</td>
</tr>
<tr>
<td>17:04:12</td>
<td>58,803</td>
</tr>
<tr>
<td>17:17:53</td>
<td>70,538</td>
</tr>
<tr>
<td>17:22:52</td>
<td>30,633</td>
</tr>
<tr>
<td>17:25:25</td>
<td>43,560</td>
</tr>
<tr>
<td>17:31:02</td>
<td>69,867</td>
</tr>
<tr>
<td>17:50:31</td>
<td>162,094</td>
</tr>
<tr>
<td>18:00:43</td>
<td>127,168</td>
</tr>
<tr>
<td>18:02:54</td>
<td>127,999</td>
</tr>
<tr>
<td>18:04:09</td>
<td>109,519</td>
</tr>
<tr>
<td>18:12:04</td>
<td>123,991</td>
</tr>
<tr>
<td>18:17:29</td>
<td>63,554</td>
</tr>
<tr>
<td>18:20:45</td>
<td>48,520</td>
</tr>
<tr>
<td>18:23:24</td>
<td>181,188</td>
</tr>
<tr>
<td>18:27:27</td>
<td>158,768</td>
</tr>
<tr>
<td>18:39:22</td>
<td>163,762</td>
</tr>
<tr>
<td>18:45:01</td>
<td>189,698</td>
</tr>
<tr>
<td>19:08:04</td>
<td>98,758</td>
</tr>
<tr>
<td>19:09:15</td>
<td>70,864</td>
</tr>
<tr>
<td>19:12:53</td>
<td>69,786</td>
</tr>
<tr>
<td>19:15:39</td>
<td>69,863</td>
</tr>
<tr>
<td>19:26:00</td>
<td>208746</td>
</tr>
<tr>
<td>19:38:05</td>
<td>215,780</td>
</tr>
<tr>
<td>19:56:24</td>
<td>184,449</td>
</tr>
<tr>
<td>20:03:47</td>
<td>202,946</td>
</tr>
<tr>
<td>20:08:39</td>
<td>175,430</td>
</tr>
<tr>
<td>20:13:03</td>
<td>161,017</td>
</tr>
<tr>
<td>20:15:08</td>
<td>174,941</td>
</tr>
<tr>
<td>20:29:59</td>
<td>146,447</td>
</tr>
<tr>
<td>20:31:13</td>
<td>217,747</td>
</tr>
<tr>
<td>20:35:43</td>
<td>199,209</td>
</tr>
<tr>
<td>20:38:50</td>
<td>183,515</td>
</tr>
<tr>
<td>20:40:36</td>
<td>146,219</td>
</tr>
<tr>
<td>20:43:27</td>
<td>179,772</td>
</tr>
<tr>
<td>20:46:04</td>
<td>185,481</td>
</tr>
<tr>
<td>20:49:13</td>
<td>215,451</td>
</tr>
<tr>
<td>20:50:39</td>
<td>195,725</td>
</tr>
<tr>
<td>20:51:47</td>
<td>167,884</td>
</tr>
<tr>
<td>20:53:04</td>
<td>216,923</td>
</tr>
</tbody>
</table>
<ul>
<li>Best 217,747</li>
<li>Last 216,923</li>
</ul>
<h2 id="結果">結果</h2>
<p>両日3チームを除いた上位12チームにおいて、8番目(全体で14位)でなんとかギリギリ本戦出場権を得られました。
ISUCON4 以来の2回目です。
ちなみに ISUCON4 のときも総合トップ13枠で8位だった。</p>
<h2 id="使用したツール">使用したツール</h2>
<ul>
<li>kataribe
<ul>
<li>matsuu++</li>
</ul>
</li>
<li>tcpdump</li>
<li>Wireshark</li>
<li>goreplay
<ul>
<li>今回は複数台サーバがあったのであまり使わなかったが、ローカルでリクエストをリプレイしてアプリの挙動に問題ないか確認に使おうと思っていた。</li>
</ul>
</li>
<li>netdata</li>
<li>NewRelic
<ul>
<li>Go のライブラリだとあまり意味がなかった</li>
<li>Runtime GC のところだけチラっと見たくらい</li>
</ul>
</li>
<li>BitBucket</li>
<li>ansible</li>
<li>mosh</li>
<li>Dropbox Paper</li>
</ul>
<h2 id="やったこと">やったこと</h2>
<h3 id="前日まで">前日まで</h3>
<ul>
<li>Dropbox Paper で当日のスケジュールをおおまかに決め共有</li>
<li>Pixiv ISUCON で勉強</li>
<li>当日のお昼ご飯
<ul>
<li>事前に出前を予約。 <img src="https://kjmkznr.github.io/images/20171026/launch.jpg" alt="Launch"></li>
</ul>
</li>
</ul>
<h3 id="当日">当日</h3>
<h4 id="序盤">序盤</h4>
<ul>
<li>初期セットアップ
<ul>
<li>ソースコードを git にぶっこんでサーバで git pull が行えるようにする</li>
<li>ツールのインストールやSSH鍵を登録する Ansible Playbook をサーバに展開、適用</li>
<li>fail2ban 無効化
<ul>
<li>事前に Ubuntu を試したときにハマったメンバーがいたので。</li>
</ul>
</li>
<li>画像のスタティックファイル化
<ul>
<li>nyaa がさくっと実装</li>
<li>pixxiv-isucon 予習の成果</li>
</ul>
</li>
</ul>
</li>
<li>nginx の設定をチューニング1
<ul>
<li>Expires, Cache-Control ヘッダまわりを追加</li>
<li>ETag 無効化</li>
<li>これも nyaa がさくっと設定</li>
<li>pixxiv-isucon 予習の成果</li>
</ul>
</li>
<li>message テーブルにインデックスを張る
<ul>
<li><code>ALTER TABLE message ADD INDEX(channel_id);</code></li>
<li>これも nyaa</li>
</ul>
</li>
<li>/message のチューニング
<ul>
<li>N+1 を改善</li>
<li>これも nyaa</li>
</ul>
</li>
<li>/fetch のチューニング
<ul>
<li>私が担当したが N+1 のクエリの排除までいけず。</li>
<li>haveread を Redis 化した方が良いよなーとつぶやいてたけど、結局実行せず。</li>
<li>nyaa にバトンタッチして改善</li>
<li>time.Sleep を消したりもしてみたが、リクエスト数が増えるだけで効果がないので戻した</li>
</ul>
</li>
<li>このあたりのベストスコアが142,119点だったけど、なかなか安定せず</li>
</ul>
<h4 id="中盤">中盤</h4>
<ul>
<li>message テーブルにさらにインデックスを追加
<ul>
<li><code>ALTER TABLE message ADD INDEX(user_id);</code></li>
<li>最終的に <code>ALTER TABLE message ADD INDEX(channel_id, user_id);</code> というインデックスに集約。</li>
</ul>
</li>
<li>複数台構成への変更
<ul>
<li>いくつか案が出た
<ul>
<li>没案としては NFS や WebDav など。</li>
<li>NFS は再起動時に刺さりそうだったのでやめた</li>
</ul>
</li>
<li>/icons 以下を3台のサーバに分散配置し、ローカルにない場合は存在するノードにリダイレクトするような処理を2matzが実装
<ul>
<li>残念ながらベンチマーカーがリダイレクトしてくれなかったのでロールバック</li>
</ul>
</li>
<li>nginx のみで複数台構成への切り替え
<ul>
<li>私が担当した。</li>
<li>上で書いた分散配置の施策は変更が大きくなりそうだったため、予備の案を考えておいた</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>app1, app2</p>
<pre><code>server {
        location /icons/ {
                proxy_pass http://app3;
        }
        location / {
                proxy_pass http://127.0.0.1:5000;
        }
}
</code></pre>
<p>app3</p>
<pre><code>upstream backend {                                                              
        server app1:5000;
        server app2:5000;
}
server {
        location /icons/ {
                add_header Pragma public;
                add_header Cache-Control &quot;public, must-revalidate, proxy-revalidate&quot;;
                expires max;
                etag off;
        }
        location /profile {
                proxy_pass http://127.0.0.1:5000;
        }
        location / {
                proxy_pass http://backend;
        }
}
</code></pre>
<h4 id="終盤">終盤</h4>
<ul>
<li>app1, app2 に proxy_cache の設定を追加</li>
<li>/history を改善</li>
<li>サーバの再起動テスト
<ul>
<li>1台ずつ再起動し無事起動してくることを祈る</li>
</ul>
</li>
<li>各種ログの停止</li>
<li>MySQL のチューニング
<ul>
<li><code>innodb_doublewrite = 0</code></li>
<li><code>innodb_flush_log_at_trx_commit = 2</code></li>
</ul>
</li>
<li>ベンチガチャ
<ul>
<li>Goのアプリのメモリが肥大化するので、ベンチのたびに再起動させたり。</li>
<li>ベストスコアに近い値を出すまで繰替えしベンチ</li>
</ul>
</li>
<li>祈り</li>
</ul>
<h2 id="まとめと反省">まとめと反省</h2>
<ul>
<li>
<p>だいたい nyaa の成果。</p>
<ul>
<li>nyaa に感謝</li>
</ul>
</li>
<li>
<p>「推測するな計測しろ」の原則をあまり守れなかった</p>
<ul>
<li>netdata を使ってウォッチしていたが、大まかにしか見れていなかった</li>
<li>ISUCON の場合 Mackerel などで見れる 1分単位のメトリクスだと粒度が粗いので netdata を入れて見るのが楽。
<ul>
<li>ただ複数台をウォッチしにくい</li>
</ul>
</li>
<li><a href="http://kjmkznr.github.io/post/consul-prometheus/">2015年の記事で使用している Prometheus</a>とGrafanaでダッシュボードを用意したかった</li>
</ul>
</li>
<li>
<p>毎度のことながら SQL 力の不足</p>
</li>
<li>
<p>毎度のことながら コミュニケーション不足</p>
<ul>
<li>前回より大分マシだった</li>
<li>座席の位置とかも重要かもしれない</li>
</ul>
</li>
<li>
<p>app3 に負荷が集中する構成だったのは良くなかった</p>
<ul>
<li>app1, app2 だけでベンチを走らせてみればよかった</li>
</ul>
</li>
<li>
<p>ベンチマーカーのエラー「too many connections」の発生条件がよくわからなかった</p>
<ul>
<li>同時接続数の問題なんだろうけれど、ベンチマーカのバグなのか、仕様なのか判断がつかなかった。</li>
</ul>
<p><code>10/22 18:27:20 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 18:27:19.812958767 +0900 JST m=+56.143739094 リクエストに失敗しました Post http://isubata.example.com/message: dial tcp 59.106.218.178:80: socket: too many open files (POST /message )</code></p>
</li>
<li>
<p>ルールを熟読しよう</p>
<ul>
<li>どのようなリクエストのポイントが高いのか、ルールに書かれているのならば把握して意識すべき</li>
</ul>
</li>
</ul>
<h2 id="最後に">最後に</h2>
<p>pixiv-isucon を作成、公開してくださった catatsuyさん、毎回大変な準備をされている運営の皆様には深く御礼申し上げます。
本戦がんばろう。</p>
    </div>
    <div class="post-footer">
      
    </div>
    
  </div>
  <div class="col-sm-4">
    <h3>
  Author
</h3>

<p>
  <div class="media">
    <img src="http://www.gravatar.com/avatar/6b632023a694f9c3d108d0d3ef819ef3?s=100" alt="KOJIMA Kazunori" class="pull-left">
    <div class="media-body">
      <h4 class="media-heading">KOJIMA Kazunori</h4>
    </div>
  </div>
</p>

<p><a href="https://twitter.com/kjm" class="twitter-follow-button" data-show-screen-name="false" data-show-count="true" data-dnt="true" data-size="large">Follow @kjm</a></p>

  </div>
</div>
      <div class="row footer">
        <div class="col-sm-12 text-center">
          &copy; 2015.
Built with <a href="http://gohugo.io/">Hugo</a> and
<a href="https://github.com/chibicode/hugo-theme-shiori">Shiori Theme</a>.

        </div>
      </div>
    </div>
    <script src="https://kjmkznr.github.io/javascripts/shiori.js"></script>
    


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </body>
</html>

