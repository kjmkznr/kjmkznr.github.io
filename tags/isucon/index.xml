<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Isucon on ただのメモ</title>
    <link>https://kjmkznr.github.io/tags/isucon/</link>
    <description>Recent content in Isucon on ただのメモ</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Sun, 22 Aug 2021 16:00:00 +0000</lastBuildDate>
    <atom:link href="/tags/isucon/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>ISUCON11 予選参戦メモ</title>
      <link>https://kjmkznr.github.io/post/20210822/isucon11-qual/</link>
      <pubDate>Sun, 22 Aug 2021 16:00:00 +0000</pubDate>
      
      <guid>https://kjmkznr.github.io/post/20210822/isucon11-qual/</guid>
      <description>&lt;p&gt;2021/08/22 に開催された ISUCON11 の予選に参加してきたときのメモ。&lt;/p&gt;

&lt;h2 id=&#34;チーム構成&#34;&gt;チーム構成&lt;/h2&gt;

&lt;h3 id=&#34;チーム名&#34;&gt;チーム名&lt;/h3&gt;

&lt;p&gt;Oops!&lt;/p&gt;

&lt;h3 id=&#34;メンバー&#34;&gt;メンバー&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;2matzzz&lt;/li&gt;
&lt;li&gt;nyaa&lt;/li&gt;
&lt;li&gt;kjm&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;昔は同僚だったけど、いまはそれぞれ別の会社で働いているメンバー達。&lt;/p&gt;

&lt;h3 id=&#34;選択言語&#34;&gt;選択言語&lt;/h3&gt;

&lt;p&gt;Go言語&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h2 id=&#34;スコア&#34;&gt;スコア&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://kjmkznr.github.io/images/20210822/isucon11-qual-score.png&#34; alt=&#34;Oops! のみのグラフ&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Best/Latest 590,351&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;結果&#34;&gt;結果&lt;/h2&gt;

&lt;h2 id=&#34;最終的にチームでやったこと&#34;&gt;最終的にチームでやったこと&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;アプリケーションのビルド、ログのローテーション、サービスの再起動を行う Makefile を書いた&lt;/li&gt;
&lt;li&gt;isu_condition table の (jia_isu_uuid, timestamp) に index&lt;/li&gt;
&lt;li&gt;POST /api/condition/{uuid} を Bulk Insert な形に変更&lt;/li&gt;
&lt;li&gt;isuテーブルを参照するQueryでカラムを指定

&lt;ul&gt;
&lt;li&gt;image カラムを読みたくなかった&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;dropProbability を削除&lt;/li&gt;
&lt;li&gt;echo, nginx のログ出力停止&lt;/li&gt;
&lt;li&gt;nginx の gzip on&lt;/li&gt;
&lt;li&gt;App x2, DB x1&lt;/li&gt;
&lt;li&gt;/assets を nginx からレスポンス&lt;/li&gt;
&lt;li&gt;user をキャッシュ&lt;/li&gt;
&lt;li&gt;isu_condition.created_at カラムを削除&lt;/li&gt;
&lt;li&gt;isu_condition テーブルに condition_level カラムを追加&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;やろうとして間に合わなかったこと&#34;&gt;やろうとして間に合わなかったこと&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;getTrend() のキャッシュ

&lt;ul&gt;
&lt;li&gt;ラスト1時間の時点で実装されていたが、ベンチ走らせたところ GOAWAY のバグを踏んでスコアが上がらなかったのでRevert&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;icon の静的化&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>ISUCON7 予選参戦メモ</title>
      <link>https://kjmkznr.github.io/post/20171026/isucon7-qual/</link>
      <pubDate>Thu, 26 Oct 2017 16:00:00 +0000</pubDate>
      
      <guid>https://kjmkznr.github.io/post/20171026/isucon7-qual/</guid>
      <description>&lt;p&gt;2017/10/21〜22 に開催された ISUCON7 の予選に参加して、予選突破できたので、そのときのメモです。
22日（日曜）の方に参加しました。&lt;/p&gt;

&lt;h2 id=&#34;チーム構成&#34;&gt;チーム構成&lt;/h2&gt;

&lt;h3 id=&#34;チーム名&#34;&gt;チーム名&lt;/h3&gt;

&lt;p&gt;oops&lt;/p&gt;

&lt;h3 id=&#34;メンバー&#34;&gt;メンバー&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;2matz(インフラ、アプリ）&lt;/li&gt;
&lt;li&gt;nyaa（アプリ、インフラ）&lt;/li&gt;
&lt;li&gt;kjm（インフラ、アプリ）&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;今は全員&lt;a href=&#34;http://www.4cast.co.jp/recruit/recruit/carrier.html&#34;&gt;同僚&lt;/a&gt;。&lt;/p&gt;

&lt;h3 id=&#34;選択言語&#34;&gt;選択言語&lt;/h3&gt;

&lt;p&gt;Go言語&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h2 id=&#34;点数の推移&#34;&gt;点数の推移&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://kjmkznr.github.io/images/20171026/isucon7-qual-1.png&#34; alt=&#34;oops のみのグラフ&#34; /&gt;&lt;/p&gt;

&lt;p&gt;16時くらいまでは暫定一位だった。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://kjmkznr.github.io/images/20171026/isucon7-qual-2.png&#34; alt=&#34;予選通過チームを含むグラフ&#34; /&gt;&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;時間&lt;/th&gt;
&lt;th&gt;Score&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;13:05:29&lt;/td&gt;
&lt;td&gt;3,468&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;13:15:12&lt;/td&gt;
&lt;td&gt;6,036&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;13:47:44&lt;/td&gt;
&lt;td&gt;17,721&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;13:53:41&lt;/td&gt;
&lt;td&gt;19,535&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;14:00:59&lt;/td&gt;
&lt;td&gt;1,733&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;14:02:11&lt;/td&gt;
&lt;td&gt;27,345&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;14:18:39&lt;/td&gt;
&lt;td&gt;19,320&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;14:29:11&lt;/td&gt;
&lt;td&gt;26,212&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;14:30:58&lt;/td&gt;
&lt;td&gt;82,260&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;14:32:33&lt;/td&gt;
&lt;td&gt;85,310&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;14:49:54&lt;/td&gt;
&lt;td&gt;36,704&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;14:52:45&lt;/td&gt;
&lt;td&gt;27,995&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15:18:13&lt;/td&gt;
&lt;td&gt;100,117&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15:22:43&lt;/td&gt;
&lt;td&gt;69,093&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15:29:11&lt;/td&gt;
&lt;td&gt;31,157&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15:38:11&lt;/td&gt;
&lt;td&gt;65,097&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15:39:40&lt;/td&gt;
&lt;td&gt;68,131&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15:42:03&lt;/td&gt;
&lt;td&gt;106,396&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15:48:01&lt;/td&gt;
&lt;td&gt;98,140&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:03:03&lt;/td&gt;
&lt;td&gt;85,097&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:08:42&lt;/td&gt;
&lt;td&gt;142,119&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:18:00&lt;/td&gt;
&lt;td&gt;30,340&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:22:39&lt;/td&gt;
&lt;td&gt;57,593&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:26:21&lt;/td&gt;
&lt;td&gt;44,667&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:30:43&lt;/td&gt;
&lt;td&gt;38,876&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:32:31&lt;/td&gt;
&lt;td&gt;67,046&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:37:13&lt;/td&gt;
&lt;td&gt;37,649&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:42:17&lt;/td&gt;
&lt;td&gt;46,491&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;16:45:52&lt;/td&gt;
&lt;td&gt;32,706&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;17:01:03&lt;/td&gt;
&lt;td&gt;91,630&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;17:04:12&lt;/td&gt;
&lt;td&gt;58,803&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;17:17:53&lt;/td&gt;
&lt;td&gt;70,538&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;17:22:52&lt;/td&gt;
&lt;td&gt;30,633&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;17:25:25&lt;/td&gt;
&lt;td&gt;43,560&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;17:31:02&lt;/td&gt;
&lt;td&gt;69,867&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;17:50:31&lt;/td&gt;
&lt;td&gt;162,094&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:00:43&lt;/td&gt;
&lt;td&gt;127,168&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:02:54&lt;/td&gt;
&lt;td&gt;127,999&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:04:09&lt;/td&gt;
&lt;td&gt;109,519&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:12:04&lt;/td&gt;
&lt;td&gt;123,991&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:17:29&lt;/td&gt;
&lt;td&gt;63,554&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:20:45&lt;/td&gt;
&lt;td&gt;48,520&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:23:24&lt;/td&gt;
&lt;td&gt;181,188&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:27:27&lt;/td&gt;
&lt;td&gt;158,768&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:39:22&lt;/td&gt;
&lt;td&gt;163,762&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;18:45:01&lt;/td&gt;
&lt;td&gt;189,698&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;19:08:04&lt;/td&gt;
&lt;td&gt;98,758&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;19:09:15&lt;/td&gt;
&lt;td&gt;70,864&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;19:12:53&lt;/td&gt;
&lt;td&gt;69,786&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;19:15:39&lt;/td&gt;
&lt;td&gt;69,863&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;19:26:00&lt;/td&gt;
&lt;td&gt;208746&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;19:38:05&lt;/td&gt;
&lt;td&gt;215,780&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;19:56:24&lt;/td&gt;
&lt;td&gt;184,449&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:03:47&lt;/td&gt;
&lt;td&gt;202,946&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:08:39&lt;/td&gt;
&lt;td&gt;175,430&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:13:03&lt;/td&gt;
&lt;td&gt;161,017&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:15:08&lt;/td&gt;
&lt;td&gt;174,941&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:29:59&lt;/td&gt;
&lt;td&gt;146,447&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:31:13&lt;/td&gt;
&lt;td&gt;217,747&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:35:43&lt;/td&gt;
&lt;td&gt;199,209&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:38:50&lt;/td&gt;
&lt;td&gt;183,515&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:40:36&lt;/td&gt;
&lt;td&gt;146,219&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:43:27&lt;/td&gt;
&lt;td&gt;179,772&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:46:04&lt;/td&gt;
&lt;td&gt;185,481&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:49:13&lt;/td&gt;
&lt;td&gt;215,451&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:50:39&lt;/td&gt;
&lt;td&gt;195,725&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:51:47&lt;/td&gt;
&lt;td&gt;167,884&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;20:53:04&lt;/td&gt;
&lt;td&gt;216,923&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;ul&gt;
&lt;li&gt;Best 217,747&lt;/li&gt;
&lt;li&gt;Last 216,923&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;結果&#34;&gt;結果&lt;/h2&gt;

&lt;p&gt;両日3チームを除いた上位12チームにおいて、8番目(全体で14位)でなんとかギリギリ本戦出場権を得られました。
ISUCON4 以来の2回目です。
ちなみに ISUCON4 のときも総合トップ13枠で8位だった。&lt;/p&gt;

&lt;h2 id=&#34;使用したツール&#34;&gt;使用したツール&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;kataribe

&lt;ul&gt;
&lt;li&gt;matsuu++&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;tcpdump&lt;/li&gt;
&lt;li&gt;Wireshark&lt;/li&gt;
&lt;li&gt;goreplay

&lt;ul&gt;
&lt;li&gt;今回は複数台サーバがあったのであまり使わなかったが、ローカルでリクエストをリプレイしてアプリの挙動に問題ないか確認に使おうと思っていた。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;netdata&lt;/li&gt;
&lt;li&gt;NewRelic

&lt;ul&gt;
&lt;li&gt;Go のライブラリだとあまり意味がなかった&lt;/li&gt;
&lt;li&gt;Runtime GC のところだけチラっと見たくらい&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;BitBucket&lt;/li&gt;
&lt;li&gt;ansible&lt;/li&gt;
&lt;li&gt;mosh&lt;/li&gt;
&lt;li&gt;Dropbox Paper&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;やったこと&#34;&gt;やったこと&lt;/h2&gt;

&lt;h3 id=&#34;前日まで&#34;&gt;前日まで&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Dropbox Paper で当日のスケジュールをおおまかに決め共有&lt;/li&gt;
&lt;li&gt;Pixiv ISUCON で勉強&lt;/li&gt;
&lt;li&gt;当日のお昼ご飯

&lt;ul&gt;
&lt;li&gt;事前に出前を予約。 &lt;img src=&#34;https://kjmkznr.github.io/images/20171026/launch.jpg&#34; alt=&#34;Launch&#34; /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;当日&#34;&gt;当日&lt;/h3&gt;

&lt;h4 id=&#34;序盤&#34;&gt;序盤&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;初期セットアップ

&lt;ul&gt;
&lt;li&gt;ソースコードを git にぶっこんでサーバで git pull が行えるようにする&lt;/li&gt;
&lt;li&gt;ツールのインストールやSSH鍵を登録する Ansible Playbook をサーバに展開、適用&lt;/li&gt;
&lt;li&gt;fail2ban 無効化

&lt;ul&gt;
&lt;li&gt;事前に Ubuntu を試したときにハマったメンバーがいたので。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;画像のスタティックファイル化

&lt;ul&gt;
&lt;li&gt;nyaa がさくっと実装&lt;/li&gt;
&lt;li&gt;pixxiv-isucon 予習の成果&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;nginx の設定をチューニング1

&lt;ul&gt;
&lt;li&gt;Expires, Cache-Control ヘッダまわりを追加&lt;/li&gt;
&lt;li&gt;ETag 無効化&lt;/li&gt;
&lt;li&gt;これも nyaa がさくっと設定&lt;/li&gt;
&lt;li&gt;pixxiv-isucon 予習の成果&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;message テーブルにインデックスを張る

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ALTER TABLE message ADD INDEX(channel_id);&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;これも nyaa&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;/message のチューニング

&lt;ul&gt;
&lt;li&gt;N+1 を改善&lt;/li&gt;
&lt;li&gt;これも nyaa&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;/fetch のチューニング

&lt;ul&gt;
&lt;li&gt;私が担当したが N+1 のクエリの排除までいけず。&lt;/li&gt;
&lt;li&gt;haveread を Redis 化した方が良いよなーとつぶやいてたけど、結局実行せず。&lt;/li&gt;
&lt;li&gt;nyaa にバトンタッチして改善&lt;/li&gt;
&lt;li&gt;time.Sleep を消したりもしてみたが、リクエスト数が増えるだけで効果がないので戻した&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;このあたりのベストスコアが142,119点だったけど、なかなか安定せず&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;中盤&#34;&gt;中盤&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;message テーブルにさらにインデックスを追加

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ALTER TABLE message ADD INDEX(user_id);&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;最終的に &lt;code&gt;ALTER TABLE message ADD INDEX(channel_id, user_id);&lt;/code&gt; というインデックスに集約。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;複数台構成への変更

&lt;ul&gt;
&lt;li&gt;いくつか案が出た

&lt;ul&gt;
&lt;li&gt;没案としては NFS や WebDav など。&lt;/li&gt;
&lt;li&gt;NFS は再起動時に刺さりそうだったのでやめた&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;/icons 以下を3台のサーバに分散配置し、ローカルにない場合は存在するノードにリダイレクトするような処理を2matzが実装

&lt;ul&gt;
&lt;li&gt;残念ながらベンチマーカーがリダイレクトしてくれなかったのでロールバック&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;nginx のみで複数台構成への切り替え

&lt;ul&gt;
&lt;li&gt;私が担当した。&lt;/li&gt;
&lt;li&gt;上で書いた分散配置の施策は変更が大きくなりそうだったため、予備の案を考えておいた&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;app1, app2&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;server {
        location /icons/ {
                proxy_pass http://app3;
        }
        location / {
                proxy_pass http://127.0.0.1:5000;
        }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;app3&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;upstream backend {                                                              
        server app1:5000;
        server app2:5000;
}
server {
        location /icons/ {
                add_header Pragma public;
                add_header Cache-Control &amp;quot;public, must-revalidate, proxy-revalidate&amp;quot;;
                expires max;
                etag off;
        }
        location /profile {
                proxy_pass http://127.0.0.1:5000;
        }
        location / {
                proxy_pass http://backend;
        }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;終盤&#34;&gt;終盤&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;app1, app2 に proxy_cache の設定を追加&lt;/li&gt;
&lt;li&gt;/history を改善&lt;/li&gt;
&lt;li&gt;サーバの再起動テスト

&lt;ul&gt;
&lt;li&gt;1台ずつ再起動し無事起動してくることを祈る&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;各種ログの停止&lt;/li&gt;
&lt;li&gt;MySQL のチューニング

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;innodb_doublewrite = 0&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;innodb_flush_log_at_trx_commit = 2&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ベンチガチャ

&lt;ul&gt;
&lt;li&gt;Goのアプリのメモリが肥大化するので、ベンチのたびに再起動させたり。&lt;/li&gt;
&lt;li&gt;ベストスコアに近い値を出すまで繰替えしベンチ&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;祈り&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;まとめと反省&#34;&gt;まとめと反省&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;だいたい nyaa の成果。

&lt;ul&gt;
&lt;li&gt;nyaa に感謝&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;「推測するな計測しろ」の原則をあまり守れなかった

&lt;ul&gt;
&lt;li&gt;netdata を使ってウォッチしていたが、大まかにしか見れていなかった&lt;/li&gt;
&lt;li&gt;ISUCON の場合 Mackerel などで見れる 1分単位のメトリクスだと粒度が粗いので netdata を入れて見るのが楽。

&lt;ul&gt;
&lt;li&gt;ただ複数台をウォッチしにくい&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://kjmkznr.github.io/post/consul-prometheus/&#34;&gt;2015年の記事で使用している Prometheus&lt;/a&gt;とGrafanaでダッシュボードを用意したかった&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;毎度のことながら SQL 力の不足&lt;/li&gt;
&lt;li&gt;毎度のことながら コミュニケーション不足

&lt;ul&gt;
&lt;li&gt;前回より大分マシだった&lt;/li&gt;
&lt;li&gt;座席の位置とかも重要かもしれない&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;app3 に負荷が集中する構成だったのは良くなかった

&lt;ul&gt;
&lt;li&gt;app1, app2 だけでベンチを走らせてみればよかった&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ベンチマーカーのエラー「too many connections」の発生条件がよくわからなかった&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;同時接続数の問題なんだろうけれど、ベンチマーカのバグなのか、仕様なのか判断がつかなかった。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;10/22 18:27:20 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 18:27:19.812958767 +0900 JST m=+56.143739094 リクエストに失敗しました Post http://isubata.example.com/message: dial tcp 59.106.218.178:80: socket: too many open files (POST /message )&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;ルールを熟読しよう&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;どのようなリクエストのポイントが高いのか、ルールに書かれているのならば把握して意識すべき&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;最後に&#34;&gt;最後に&lt;/h2&gt;

&lt;p&gt;pixiv-isucon を作成、公開してくださった catatsuyさん、毎回大変な準備をされている運営の皆様には深く御礼申し上げます。
本戦がんばろう。&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>
